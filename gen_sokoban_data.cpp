#include <cstdint>
#include <string>
#include <vector>
#include <iostream>
#include <cstdio>
#include <cassert>
#include <algorithm>
#include <sstream>

struct Level {
	Level(const std::vector<std::string>&);
	std::vector<uint8_t> cells;
	unsigned rows, columns;
	static std::vector<Level> read_data(const std::string &);  // throws
	static constexpr uint8_t wall = 1, goal = 2, stone = 4, man = 8;
	unsigned num_stones() const { return std::count_if(cells.begin(), cells.end(), [](auto c){ return c & stone; }); }
	bool fits() const;
	std::vector<uint8_t> encoded_parts() const;
};

extern const std::string microban;


int main() {
	auto levels = Level::read_data(microban);
	std::cout << "Levels: " << levels.size() << std::endl;
	//for (int i = 0; i < levels.size(); ++i)
	//	std::cout << i + 1 << " " << levels[i].rows << "x" << levels[i].columns << " " << (levels[i].rows * levels[i].columns) << "\t" << levels[i].num_stones() << "\n";
	for (int i = 0; i < levels.size(); ++i)
		if (!levels[i].fits()) std::cout << "discard: " <<  (i + 1) << "\n";
	std::vector<uint8_t> all_levels;
	for (auto const &l: levels)
		if (l.fits()) {
			const auto enc = l.encoded_parts();
			all_levels.insert(all_levels.end(), enc.begin(), enc.end());
		}
	std::cout << "Encoded size: " << all_levels.size() << "\n" << std::endl;
	//FILE *f = fopen("aaaaa", "wb");
	//fwrite(all_levels.data(), 1, all_levels.size(), f);
	//fclose(f);
	for (unsigned i = 0; i < all_levels.size(); i += 32) {
		printf("\thex ");
		for (unsigned j = 0; j < std::min((size_t)32, all_levels.size() - i); ++j)
			printf("%02X", all_levels[i + j]);
		printf("\n");
	}
}


Level::Level(const std::vector<std::string> &lines) {
	rows = lines.size();
	assert(rows > 2);
	columns = std::max_element(lines.begin(), lines.end(), [](auto const &a, auto const &b){ return a.size() < b.size(); })->size();
	// TODO: make columns a power of 2 to better compute position from 2D values?
	assert(columns > 2);
	cells.resize(rows * columns, 0);
	uint8_t *p = cells.data();
	for (auto const &l: lines) {
		for (char c: l) {
			switch (c) {
			case ' ':
				++p;
				break;
			case '#':
				*p++ = wall;
				break;
			case '.':
				*p++ = goal;
				break;
			case '$':
				*p++ = stone;
				break;
			case '*':
				*p++ = stone | goal;
				break;
			case '@':
				*p++ = man;
				break;
			case '+':
				*p++ = man | goal;
				break;
			default:
				throw std::runtime_error("invalid character");
			}
		}
		p += columns - l.size();
	}
}


std::vector<Level> Level::read_data(const std::string &def) {
	std::istringstream f(def);
	std::string line;
	std::vector<Level> collection;
	std::vector<std::string> curr_level;
	uint32_t row_num = 0;
	while (std::getline(f, line)) {
		++row_num;
		while (line.size() && line[line.size() - 1] == '\r') line.resize(line.size() - 1);
		if (!line.size()) {
			// end of a level
			if (curr_level.size()) collection.push_back(Level(curr_level));
			curr_level.clear();
		}
		else curr_level.push_back(line);
	}
	// last \n at end of file can be missing
	if (curr_level.size()) {
		collection.push_back(Level(curr_level));
	}
	return collection;
}


bool Level::fits() const {
	return rows <= 22 && columns <= 22 && (rows * columns) <= 255;
}


std::vector<uint8_t> Level::encoded_parts() const {
	std::vector<uint8_t> e(3 + (cells.size() + 7) / 8);
	e[0] = rows;
	e[1] = columns;
	// man position
	auto i = std::find_if(cells.begin(), cells.end(), [](auto v){ return v & man; });
	e[2] = i - cells.begin();
	auto p = e.begin() + 2;
	for (int i = 0; i < cells.size(); ++i) {
		if (i % 8) {
			*p <<= 1;
			if (cells[i] & wall) *p |= 1;
		}
		else *++p = (cells[i] & wall) ? 1 : 0;
	}
	unsigned st = num_stones();
	e.push_back(st);
	for (auto i = cells.begin(); i != cells.end(); ++i)
		if (*i & stone) e.push_back(i - cells.begin());
	for (auto i = cells.begin(); i != cells.end(); ++i)
		if (*i & goal) e.push_back(i - cells.begin());
	return e;
}




const std::string microban(
R"(
####
# .#
#  ###
#*@  #
#  $ #
#  ###
####


######
#    #
# #@ #
# $* #
# .* #
#    #
######


  ####
###  ####
#     $ #
# #  #$ #
# . .#@ #
#########


########
#      #
# .**$@#
#      #
#####  #
    ####


 #######
 #     #
 # .$. #
## $@$ #
#  .$. #
#      #
########


###### #####
#    ###   #
# $$     #@#
# $ #...   #
#   ########
#####


#######
#     #
# .$. #
# $.$ #
# .$. #
# $.$ #
#  @  #
#######


  ######
  # ..@#
  # $$ #
  ## ###
   # #
   # #
#### #
#    ##
# #   #
#   # #
###   #
  #####


#####
#.  ##
#@$$ #
##   #
 ##  #
  ##.#
   ###


      #####
      #.  #
      #.# #
#######.# #
# @ $ $ $ #
# # # # ###
#       #
#########


  ######
  #    #
  # ##@##
### # $ #
# ..# $ #
#       #
#  ######
####


#####
#   ##
# $  #
## $ ####
 ###@.  #
  #  .# #
  #     #
  #######


####
#. ##
#.@ #
#. $#
##$ ###
 # $  #
 #    #
 #  ###
 ####


#######
#     #
# # # #
#. $*@#
#   ###
#####


     ###
######@##
#    .* #
#   #   #
#####$# #
    #   #
    #####


 ####
 #  ####
 #     ##
## ##   #
#. .# @$##
#   # $$ #
#  .#    #
##########


#####
# @ #
#...#
#$$$##
#    #
#    #
######


#######
#     #
#. .  #
# ## ##
#  $ #
###$ #
  #@ #
  #  #
  ####


########
#   .. #
#  @$$ #
##### ##
   #  #
   #  #
   #  #
   ####


#######
#     ###
#  @$$..#
#### ## #
  #     #
  #  ####
  #  #
  ####


####
#  ####
# . . #
# $$#@#
##    #
 ######


#####
#   ###
#. .  #
#   # #
## #  #
 #@$$ #
 #    #
 #  ###
 ####


#######
#  *  #
#     #
## # ##
 #$@.#
 #   #
 #####


# #####
  #   #
###$$@#
#   ###
#     #
# . . #
#######


 ####
 #  ###
 # $$ #
##... #
#  @$ #
#   ###
#####


 #####
 # @ #
 #   #
###$ #
# ...#
# $$ #
###  #
  ####


######
#   .#
# ## ##
#  $$@#
# #   #
#.  ###
#####


#####
#   #
# @ #
# $$###
##. . #
 #    #
 ######


     #####
     #   ##
     #    #
 ######   #
##     #. #
# $ $ @  ##
# ######.#
#        #
##########


####
#  ###
# $$ #
#... #
# @$ #
#   ##
#####


  ####
 ##  #
##@$.##
# $$  #
# . . #
###   #
  #####


 ####
##  ###
#     #
#.**$@#
#   ###
##  #
 ####


#######
#. #  #
#  $  #
#. $#@#
#  $  #
#. #  #
#######


  ####
###  ####
#       #
#@$***. #
#       #
#########


  ####
 ##  #
 #. $#
 #.$ #
 #.$ #
 #.$ #
 #. $##
 #   @#
 ##   #
  #####


####
#  ############
# $ $ $ $ $ @ #
# .....       #
###############


      ###
##### #.#
#   ###.#
#   $ #.#
# $  $  #
#####@# #
    #   #
    #####


##########
#        #
# ##.### #
# # $$ . #
# . @$## #
#####    #
    ######


#####
#   ####
# # # .#
#    $ ###
### #$.  #
#   #@   #
# # ######
#   #
#####


 #####
 #   #
##   ##
# $$$ #
# .+. #
#######


#######
#     #
#@$$$ ##
#  #...#
##    ##
 ######


   ####
   #  #
   #@ #
####$.#
#   $.#
# # $.#
#    ##
######


     ####
     # @#
     #  #
###### .#
#   $  .#
#  $$# .#
#    ####
###  #
  ####


#####
#@$.#
#####


######
#... #
#  $ #
# #$##
#  $ #
#  @ #
######


 ######
##    #
#  ## #
# # $ #
#  * .#
## #@##
 #   #
 #####


  #######
###     #
# $ $   #
# ### #####
# @ . .   #
#   ###   #
##### #####


######
#  @ #
#  # ##
# .#  ##
# .$$$ #
# .#   #
####   #
   #####


######
# @  #
# $# #
# $  #
# $ ##
### ####
 #  #  #
 #...  #
 #     #
 #######


  ####
###  #####
#  $  @..#
# $    # #
### #### #
  #      #
  ########


####
#  ###
#    ###
#  $*@ #
### .# #
  #    #
  ######


  ####
### @#
#  $ #
#  *.#
#  *.#
#  $ #
###  #
  ####


 #####
##. .##
# * * #
#  #  #
# $ $ #
## @ ##
 #####


      ######
      #    #
  ##### .  #
###  ###.  #
# $  $  . ##
# @$$ # . #
##    #####
 ######


########
# @ #  #
#      #
#####$ #
    #  ###
 ## #$ ..#
 ## #  ###
    ####


#####
#   ###
#  $  #
##* . #
 #   @#
 ######


  ####
  #  #
  #@ #
  #  #
### ####
#    * #
#  $   #
#####. #
    ####


####
#  ####
#.*$  #
# .$# #
## @  #
 #   ##
 #####


############
#          #
# ####### @##
# #         #
# #  $   #  #
# $$ #####  #
###  # # ...#
  #### #    #
       ######


 #########
 #       #
##@##### #
#  #   # #
#  #   $.#
#  ##$##.#
##$##  #.#
#   $  #.#
#   #  ###
########


########
#      #
# #### #
# #...@#
# ###$###
# #     #
#  $$ $ #
####   ##
   #.###
   ###


   ##########
####    ##  #
#  $$$....$@#
#      ###  #
#   #### ####
#####


#####   ####
#   ##### .#
#       $  ########
###  #### .$    @ #
  #  #  #  ####   #
  ####  ####  #####


 ######
##    #
#   $ #
#  $$ #
### .#####
  ##.# @ #
   #.  $ #
   #. ####
   ####


  ######
  #    #
  #  $ #
 ####$ #
## $ $ #
#....# ##
#     @ #
##  #   #
 ########


   ###
   #@#
 ###$###
##  .  ##
#  # #  #
# #   # #
# #   # #
# #   # #
#  # #  #
## $ $ ##
 ##. .##
  #   #
  #   #
  #####


#####
#   ##
# #  #
#@$*.##
##  . #
 # $# #
 ##   #
  #####


 ####
 #  ######
##    $  #
# .# $   #
# .#$#####
# .@ #
######


####  ####
#  ####  #
#  #  #  #
#  #    $##
#  . .#$  #
#@ ## # $ #
#   . #   #
###########


#####
# @ ####
#      #
# $ $$ #
##$##  #
#   ####
# ..  #
##..  #
 ###  #
   ####


###########
#     #   ###
# $@$ # .  .#
# ## ### ## #
# #       # #
# #   #   # #
# ######### #
#           #
#############


  ####
 ##  #####
 #  $  @ #
 #  $#   #
#### #####
#  #   #
#    $ #
# ..#  #
#  .####
#  ##
####


####
#  #####
# $$ $ #
#      #
## ## ##
#...#@#
# ### ##
#      #
#  #   #
########


 ####
 #  #######
 #$ @#   .#
## #$$   .#
#  $  ##..#
#   # #####
###   #
  #####


 #######
## ....##
#   ######
#   $ $ @#
###  $ $ #
  ###    #
    ######


 #####
##   #
#    #####
#  #.#   #
#@ #.# $ #
#  #.#  ##
#    #  #
##  ##$$#
 ##     #
  #  ####
  ####


##########
# @ .... #
#   ####$##
## #  $ $ #
 # $      #
 #   ######
 #####


 #######
##     ##
#  $ $  #
# $ $ $ #
## ### ####
 #@  .....#
 ##     ###
  #######


 #########
 #    #  #
## $#$#  #
#  .$.@  #
#  .#    #
##########


####
#  #######
#  . ## .#
# $#    .#
## ## # .#
 #    #  #
 #### #  #
  # @$ ###
  # $$ #
  #    #
  ######


 #####
 #   #
 # . #
## * #
#  *##
#  @##
## $ #
 #   #
 #####


#####
#   ###
# .   ##
##*#$  #
# .# $ #
# @## ##
#     #
#######


######
#    ##
# $ $ ##
## $$  #
 # #   #
 # ## ##
 #  . .#
 # @. .#
 #  ####
 ####


########
#  ... #
#  ### ##
#  # $  #
## #@$  #
 # # $  #
 # ### #####
 #         #
 #   ###   #
 ##### #####


       ####
 #######  #
 # $      #
 #   $ $  #
 # ########
## # .  #
#  # #  #
#  @ . ##
## # # #
 #   . #
 #######


    ####
  ###  ##
 ## $   #
## $  # #
# @#$$  #
# ..  ###
# ..###
#####


     ####
######  #
#       #
#  ... .#
##$######
# $  #
#   $###
##  $  #
 ## @  #
  ######


     ####
 # ###  #
 # #    #
 # #  # #
 # #$ #.#
 # #  # # #
 # #$ #.# #
   #  # # #
####$ #.# #
# @     # #
#   #  ## #
########


##########
#   ##   #
# $  $@# #
#### # $ #
   #.#  ##
 # #.# $#
 # #.   #
 # #.   #
   ######


 ########
 #  @   #
 # $  $ #
### ## ###
#  $..$  #
#   ..   #
##########


###########
#    .##  #
# $$@..$$ #
#   ##.   #
###########


  ####
  #  #    #####
  #  #    #   #
  #  ######.# #
####  $    .  #
#   $$# ###.# #
#   #   # #   #
######### #@ ##
          #  #
          ####


 #########
##   #   ##
#    #    #
#  $ # $  #
#   *.*   #
####.@.####
#   *.*   #
#  $ # $  #
#    #    #
##   #   ##
 #########


#########
# @ #   #
# $ $   #
##$### ##
#  ...  #
#   #   #
######  #
     ####


########
#@     #
# .$$. #
# $..$ #
# $..$ #
# .$$. #
#      #
########


  ######
  #    #
  #    #
#####  #
#   #.#####
#   $@$   #
#####.#   #
   ## ## ##
   #   $.#
   #   ###
   #####


   ####
   #  ########
#### $ $.....#
#   $   ######
#@### ###
#  $  #
# $ # #
## #  #
 #    #
 ######


#####
#   ## ####
#  $ ### .#
# $   $  .#
## $#####.# ####
# $  # # .###  #
#    # # .#  @ #
###  # #       #
  #### ##     ##
        #######


               #####
               #   #
#######  ####### # #
#     #  #  #      #
#  @  ####  #     ####
#  #    ....## ####  #
#    ##### ## $$ $ $ #
######   #           #
         #  ##########
         ####


#######
# @#  #
#.$   #
#. # $##
#.$#   #
#. # $ #
#  #   #
########


  #####
  #   #
  # # #######
  #  *  #   #
  ## ##   # #
  #     #*  #
### # # # ###
#  *#$+   #
# #   ## ##
#   #  *  #
####### # #
      #   #
      #####


###########
#....#    #
#  #   $$ #
#  @  ##  #
#     ##$ #
######  $ #
     #    #
     ######


  #####
  # . ##
### $  #
# . $#@#
# #$ . #
#  $ ###
## . #
 #####


    #####
#####   #
#    $  #
#  $#$#@#
### #   #
  # ... #
  ###  ##
    #  #
    ####


 #### ####
##  ###  ##
#   # #   #
#  *. .*  #
###$   $###
 #   @   #
###$   $###
#  *. .*  #
#   # #   #
##  ###  ##
 #### ####


 ########
 #      #
 #@   $ #
## ###$ #
# .....###
# $ $ $  #
###### # #
     #   #
     #####


########
#      #
# $*** #
# *  * #
# *  * #
# ***. #
#     @#
########


####     #####
#  ###   #   ##
#    #   #$ $ #
#..# ##### #  #
#  @    # $ $ #
#..#         ##
##   #########
 #####


  #######
# #     #
# # # # #
  # @ $ #
### ### #
#   ### #
# $  ##.#
## $  #.#
 ## $  .#
# ## $#.#
## ## #.#
### #   #
### #####


  ####
  #  #
  # $####
###. .  #
# $ # $ #
#  . .###
####$ #
   # @#
   ####


######
#    ####
#    ...#
#    ...#
######  #
  #  #  #
  # $$ ##
  # @$  #
  # $$  #
  ## $# #
   #    #
   ######


 #####
##   ####
#  $$$  #
# #   $ #
#   $## ##
###  #.  #
  #  #   #
 ##### ###
 #   # ##
 # @....#
 #      #
 #   #  #
 ########


   #####
  ##   #
###  # #
#    . #
#  ## #####
#  . . #  ##
#  # @ $   ###
#####. #  $  #
    ####  $  #
       ## $ ##
        #  ##
        #  #
        ####


######
#    ###
#  # $ #
#  $ @ #
## ## #####
#  #......#
# $ $ $ $ #
##   ######
 #####


    #####
#####   ####
#     #    #
#  #.....  #
##  ## # ###
 #$$@$$$ #
 #     ###
 #######


     #####
   ###   #
####.....#
# @$$$$$ #
#     # ##
#####   #
    #####


 #### ####
 #  ###  ##
 #      @ #
##..###   #
#      #  #
#...#$  # #
# ## $$ $ #
#  $    ###
####  ###
   ####


 #####
##   ##
#  $  ##
# $ $  ##
###$# . ##
  # # .  #
 ## ##.  #
 # @  . ##
 #   #  #
 ########


  ######
  #    ##
 ## ##  #
 # $$ # #
 # @$ # #
 #    # #
#### #  #
#  ... ##
#     ##
#######


      ####
#######  #
# $      ##
# $#####  #
#  @#  #  #
## ##..   #
#  # ..####
# $  ###
# $###
#  #
####


 ######
 # .  #
##$.# #
#  *  #
# ..###
##$ # #####
## ## #   #
#  #### # #
#   @ $ $ #
##  #     #
 ##########


#####
#   ###
# #$  #
# $   #
# $ $ #
# $#  #
#  @###
## ########
#      ...#
#         #
########..#
       ####


########
#      #
# $ $$ ########
##### @##. .  #
    #$  # .   #
    #   #. . ##
    #$# ## # #
    #        #
    #  ###  ##
    #  # ####
    ####


##############
#      #     #
# $@$$ # . ..#
## ## ### ## #
 # #       # #
 # #   #   # #
 # ######### #
 #           #
 #############


      #####
      #   ##
      # $  #
######## #@##
# .  # $ $  #
#        $# #
#...#####   #
#####   #####


 ###########
##.......  #
# $$$$$$$@ #
#   # # # ##
# # #     #
#   #######
#####


## ####
####  ####
 # $ $.  #
## #  .$ #
#   ##.###
#  $  . #
# @ #   #
#  ######
####


  #########
###   #   #
# * $ . . #
#   $ ## ##
####*#   #
 #  @  ###
 #   ###
 #####


  #########
### @ #   #
# * $ *.. #
#   $ #   #
####*#  ###
 #     ##
 #   ###
 #####


#####  #####
#   ####.. #
# $$$      #
#   $#  .. #
### @#  ## #
  #  ##    #
  ##########


#####
#   #
# . #
#.@.###
##.#  #
#  $  #
# $   #
##$$  #
 #  ###
 #  #
 ####


####
# @###
#.*  #####
#..#$$ $ #
##       #
 # # ##  #
 #   #####
 #####


 #######
 #  . .###
 # . . . #
### #### #
#  @$  $ #
#  $$  $ #
####   ###
   #####


        ####
#########  #
#   ## $   #
#  $   ##  #
### #. .# ##
  # #. .#$##
  # #   #  #
  # @ $    #
  #  #######
  ####


#######
#     #####
# $$#@##..#
# #       #
#  $ # #  #
#### $  ..#
   ########


 #######
 #     #
## ###$##
#.$   @ #
# .. #$ #
#.##  $ #
#    ####
######


       ####
      ##  ###
####  #  $  #
#  #### $ $ #
#   ..# #$  #
#  #   @  ###
## #..# ###
 # ## # #
 #      #
 ########


  ####
###  #
#    ###
# # . .#
# @ ...####
# # # #   ##
#   # $$   #
#####  $ $ #
    ##$ # ##
     #    #
     ######


 ####
##  ####
#   ...#
#   ...#
#   # ##
#   #@ #### ####
##### $   ###  #
    #  ##$ $   #
   ###     $$  #
   # $  ##   ###
   #    ######
   ######


######## #####
#  #   ###   #
#      ## $  #
#.# @ ## $  ##
#.#   # $  ##
#.#    $  ##
#. ## #####
##    #
 ######


  ########
  #  # . #
  #   .*.#
  #  # * #
####$##.##
#      $ #
# $ ## $ #
#   @#   #
##########


  ####
  #  #
  #  ####
###$.$  #
#  .@.  #
#  $.$###
####  #
   #  #
   ####


####
#  ####
# $   #
# .#  #
# $# ##
# .  #
#### #
   # #
 ### ###
 #  $  #
## #$# ##
# $ @ $ #
# ..#.. #
###   ###
  #####


   ####
 ###  #####
 # $$ #   #
 # $ . .$$##
 # .. #. $ #
### #** .  #
#  . **# ###
# $ .# .. #
##$$.@. $ #
 #   # $$ #
 #####  ###
     ####


   #####
   # @ #
  ##   ##
###.$$$.###
#  $...$  #
#  $.#.$  #
#  $...$  #
###.$$$.###
  ##   ##
   #   #
   #####


 #######
##  .  ##
# .$$$. #
# $. .$ #
#.$ @ $.#
# $. .$ #
# .$$$. #
##  .  ##
 #######


       #####
########   #
#.   .  @#.#
#  ###     #
## $  #    #
 # $   #####
 # $#  #
 ## #  #
  #   ##
  #####


###########
#  .  #   #
# #.  @   #
#  #..# #######
##  ## $$ $ $ #
 ##           #
  #############


 ####
##  ###
#@$   #
### $ #
 #  ######
 #  $....#
 #  # ####
 ## # #
 # $# #
 #    #
 #  ###
 ####


     ####
 #####  #
 #     $#######
## ## ..#  ...#
# $ $$#$  @   #
#        ###  #
#######  # ####
      ####


   ####
   #  #
 ###  #
##  $ #
#   # #
# #$$ ######
# #   #   .#
#  $  @   .#
###  ####..#
  ####  ####


###### ####
#     #    #
#.##  #$##  #
#   #     #  #
#$  # ###  #  #
# #      #  # #
# # ####  # # #
#. @    $ * . #
###############


#############
#.# @#  #   #
#.#$$   # $ #
#.#  # $#   #
#.# $#  # $##
#.#  # $#  #
#.# $#  # $#
#..  # $   #
#..  #  #  #
############


 ############################
 #                          #
 # ######################## #
 # #                      # #
 # # #################### # #
 # # #                  # # #
 # # # ################ # # #
 # # # #              # # # #
 # # # # ############ # # # #
 # # # # #            # # # #
 # # # # # ############ # # #
 # # # # #              # # #
 # # # # ################ # #
 # # # #                  # #
##$# # #################### #
#. @ #                      #
#############################


    ######               ####
#####*#  #################  ##
#   ###                      #
#        ########  ####  ##  #
### ####     #  ####  ####  ##
#*# # .# # # #     #     #   #
#*# #  #     # ##  # ##  ##  #
###    ### ###  # ##  # ##  ##
 #   # #*#      #     # #    #
 #   # ###  #####  #### #    #
 #####   #####  ####### ######
 #   # # #**#               #
## # #   #**#  #######  ##  #
#    #########  #    ##### ###
# #             # $        #*#
#   #########  ### @#####  #*#
#####       #### ####   ######
)"
);

